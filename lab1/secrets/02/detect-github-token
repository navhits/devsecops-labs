#!/bin/bash

set -e

docker run -v $(pwd):/src ghcr.io/gitleaks/gitleaks:latest dir /src -f json -r - 2>/dev/null | \
jq -r '.[].Secret' | while IFS= read -r secret; do
  echo "Found secret: $secret"

  if [[ $secret == ghp_* || $secret == github_pat_* ]]; then
    if curl -s -H "Authorization: Bearer $secret" https://api.github.com/user | grep -q '"login"'; then
      echo "✅ Valid GitHub token"
    else
      echo "❌ Invalid GitHub token"
    fi
  else
    echo "❌ Unrecognized or invalid secret format"
  fi

  echo "---"
done
